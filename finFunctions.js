var internetSearchEngineAdRevenue = [19443,26145,31221,32157.63,33122.3589,34116.029667,35139.51055701,36193.6958737203,37279.5067499319,38397.8919524299,39549.8287110028];
var googleWebSites = [8793,10386,12465,12714.3,12968.586,13227.95772,13492.5168744,13762.367211888,14037.6145561258,14318.3668472483,14604.7341841932];
var googleNetworkWebSites = [0,0,2621,2673.42,2726.8884,2781.426168,2837.05469136,2893.7957851872,2951.67170089094,3010.70513490876,3070.91923760694];
var mobile = [1085,1374,2354,2377.54,2401.3154,2425.328554,2449.58183954,2474.0776579354,2498.81843451475,2523.8066188599,2549.0446850485];
var home = [29321,37905,49865,51138.93,52447.3491,53791.224513,55171.55119035,56589.3526290513,58045.681702787,59541.6215173837,61078.2862914277];
var cogsInclDnA = [10344,12939,16291,17431.37,18651.5659,19957.175513,21354.17779891,22848.9702448337,24448.3981619721,26159.7860333101,27990.9710556418];
var rND = [2900,4101,4685,7496,10494.4,13642.72,16371.264,18008.3904,19809.22944,21790.152384,23969.1676224];
var sNM = [2538,4228,4875,5606.25,6447.1875,7414.265625,8526.40546875,9805.3662890625,11276.1712324219,12967.5969172851,14912.7364548779];
var otherExp = [0,0,-420.78,-316.9062,-203.803914,-82.2772675,29.5227215461999,110.175966096898,201.341670632139,304.255537144232,420.302763709842];
var interestRate = [.15];

var cashEq = [44792,43348,69583,109010.478975,143048.84949875,171280.602714687,194195.861009162,213355.834247919,228238.858105178,238261.572222166,242771.448572265];
var acctsRec = [14260,18702,27173,27716.46,28270.7891999999,28836.204984,29412.92908368,30001.1876653536,30601.2114186607,31213.2356470339,31837.5003599746];
var stInv = [80136,119631,116667,119000.34,121380.3468,123807.953736,126284.11281072,128809.795066934,131385.990968273,134013.710787639,136693.985003391];
var mktSec = [0,0,0,0,0,0,0,0];
var inv = [,0,0,0,0,0,0,0,0,0] 
var defTaxAssets = [0,0,0,0,0,0,0,0];
var prepaidExp = [0,0,0,0,0,0,0,0];
var otherCurrAssets = [13067.22,13328.6,13595.14,13867.04,14144.4,14427.26,14715.8,15010.1];
var currentAssets = [,268794.498975,306028.54989875,337519.897122688,363759.941305322,386311.196150003,404653.327245302,418204.330745094,426313.062265651];

var tangibleAssets = [0,0,0,0,0,0,0,0];
var bldsStructures = [66493.35,67158.2835,67829.866335,68508.16499835,69193.2466483335,69885.1791148168,70584.030905965,71289.8712150247];
var machineryEq = [0,0,0,0,0,0,0,0];
var furnitureEq = [0,0,0,0,0,0,0,0];
var land = [0,0,0,0,0,0,0,0];
var accDep = [,22013.96,22234.0996,22456.440596,22681.00500196,22907.8150519796,23136.8932024994,23368.2621345244,23601.9447558696];
var intangAssets = [0,0,0,0,0,0,0,0];
var software = [0,0,0,0,0,0,0,0];
var goodwill = [0,0,0,0,0,0,0,0];
var otherNetInt = [0,0,0,0,0,0,0,0];
var invAndOtherAssets = [,4496.52,4541.4852,4586.900052,4632.76905252,4679.0967430452,4725.88771047565,4773.14658758041,4820.87805345621];
var invSec = [0,0,0,0,0,0,0,0];
var longTimeDeposit =[0,0,0,0,0,0,0,0];
var allowance = [0,0,0,0,0,0,0,0];
var otherRec = [0,0,0,0,0,0,0,0];
var otherLTAssets = [,70943.41,71652.8441,72369.372541,73093.06626641,73823.9969290741,74562.2368983648,75307.8592673485,76060.937860022];
var totAssets = [432741.738975,471615.26229875,504762.476646688,532674.946624562,556915.351522435,576963.524171459,592237.629640512,602086.694150024];

var stNP = [7795.2,8184.96,8594.208,9023.9184,9475.11432,9948.870036,10446.3135378,10968.62921469];
var stDebt = [12025.65,12626.9325,13258.279125,13921.19308125,14617.2527353125,15348.1153720781,16115.521140682,16921.2971977161];
var stBorrowing = [0,0,0,0,0,0,0,0];
var currentInstLTDebt = [0,0,0,0,0,0,0,0];
var bondsDue = [0,0,0,0,0,0,0,0];
var aP = [0,0,0,0,0,0,0,0];
var accExp = [0,0,0,0,0,0,0,0];
var iTaxPay = [0,0,0,0,0,0,0,0];
var allowProd = [0,0,0,0,0,0,0,0];
var divPay = [0,0,0,0,0,0,0,0];
var currentLiabilities = [53821.49,55152.5389,56536.539989,57976.00487389,59473.5693818789,61031.9997579102,62654.1991718124,64343.2145506698];
var otherCurrLiab = [34000.64,34340.6464,34684.052864,35030.89339264,35381.2023265664,35735.0143498321,36092.3644933304,36453.2881382637];

var ltDebt = [0,0,0,0,0,0,0,0];
var bond = [0,0,0,0,0,0,0,0];
var bondWarrant = [0,0,0,0,0,0,0,0];

var ltBorrow = [0,0,0,0,0,0,0,0];
var defTaxLiab = [0,0,0,0,0,0,0,0];
var provRiskCharge = [0,0,0,0,0,0,0,0];
var retirementSevBenef = [0,0,0,0,0,0,0,0];
var otherNonCurrLiab = [16858.8,17701.74,18586.827,19516.16835,20491.9767675,21516.575605875,22592.4043861688,23722.0246054772];

var redeemablePrefStock = [0,0,0,0,0,0,0,0];
var addPic = [88934.82,90713.5164,92527.786728,94378.34246256,96265.9093118112,98191.2274980474,100155.052048008,102158.153088969];
var retainedEarnings = [195147.205175,205541.19321275,209737.321700188,208231.650138516,202612.662466618,192344.223193374,176827.176024464,155391.71956198];
var tStock = [0,0,0,0,0,0,0,0];
var commonEq = [0,0,0,0,0,0,0,0];
var commonEq = [0,0,0,0,0,0,0,0];
var assetLiabDiffPlug = [77979.4238,102506.273786,127374.0012295,152572.780799596,178071.233594627,203879.498116252,230008.798010058,256471.582342928];
var cumTranslAdj = [0,0,0,0,0,0,0,0];
var unrealizedGainLossMktSec = [0,0,0,0,0,0,0,0];

var netIncome = [16162.205175,10393.98803775,4196.1284874375,-1505.67156167182,-5618.9876718982,-10268.4392732433,-15517.0471689103,-21435.456462484];
var dNA = [22013.96,22234.0996,22456.440596,22681.00500196,22907.8150519796,23136.8932024994,23368.2621345244,23601.9447558696];

var acctsRecDelta = [-554.3292,-565.415784000001,-576.724099679999,-588.258581673599,-600.023753307072,-612.024228373215,-624.26471294068];
var otherCurrAssetsDelta = [-261.3444,-266.571288000001,-271.902713760001,-277.340768035201,-282.887583395905,-288.545335063822,-294.316241765098];
var aPDelta = [-371.200000000001,-389.76,-409.248,-429.7104,-451.19592,-473.755716,-497.4435018,-522.315676890001];
var otherCurrLiabDelta = [,-5957,-7836,-336.639999999999,-340.006399999998,-343.406463999999,-346.840528640001,-350.308933926397,-353.812023265666,-357.350143498319,-360.923644933304];

var disposalFixedAssets = [0,0,0,0,0,0,0,0];
var Capex= [54050.448975,36699.53442375,30878.1262589376,25543.6637429843,21767.0319723843,17465.143434618,12576.0772748566,7030.42891134597];
var increaseInvestments= [0,0,0,0,0,0,0,0];
var decreaseInvestments= [0,0,0,0,0,0,0,0];
var purchaseInvSecurities = [2380.0068,2427.606936,2476.15907471999,2525.68225621441,2576.19590133868,2627.71981936548,2680.27421575278];
var otherInvestingActivities= [0,0,0,0,0,0,0,0];
var cashfromInvestingActivities = [-2964,2333.34,2380.0068,2427.606936,2476.15907471999,2525.68225621441,2576.19590133868,2627.71981936548,2680.27421575278];

var freeCashFlow = [90402.18795,67578.3781475,55863.776538875,45123.3421627386,37498.9311149274,28824.4599585376,18976.1845688796,7815.39969191227];

var shortTermBorrowingDelta = [0,0,0,0,0,0,0,0];
var increaseLongTermBorrowings= [0,0,0,0,0,0,0,0];

var netIncreaseShortTermLoansPayable = [371.200000000001,389.76,409.248,429.7104,451.19592,473.755716,497.4435018,522.315676890001];
var DecreaseLongTermBorrowings = [0,0,0,0,0,0,0,0];
var IncreaseCapitalStocks= [0,0,0,0,0,0,0,0];
var DecreaseCapitalStocks=[0,0,0,0,0,0,0,0];
var otherFinancingActivities= [0,0,0,0,0,0,0,0];
var cashFinancingActivities= [371.200000000001,389.76,409.248,429.7104,451.19592,473.755716,497.4435018,522.315676890001];
var NetChangesCash= [39427.478975,34038.37052375,28231.7532159375,22915.2582944744,19159.9732387575,14883.0238572583,10022.7141169885,4509.87635009909];



var taxes=[1.02,1.04,1.061,1.0718,1.08254,1.09336,1.1043,1.11534];

var sharesOut = [34.2,34.61,35.03,35.45,35.87,36.30,36.74,37.18];

var earningsPerShare = [];

var bookValue = [];
//define bookValue

function findPriceTargets(a,b,c,d) {
	var years = 8;
	
	var revenues = [internetSearchEngineAdRevenue,googleWebSites, googleNetworkWebSites, mobile, home ];
	var grossProfit = sumColumnsOfArrays(revenues);

	for (var i=0; i<grossProfit.length; i++) {
		grossProfit[i] = (grossProfit[i] * (1+a))
	}
	
	var ebit = [];
	var interestFX = [];
	var ebt = [];
	var netIncome = [];
	var ebitda = [];
	var cashFromOperatingActivities = [];

	//new block to find yearly changes for given variables
	var acctsRecDelta = findYearlyChanges(acctsRec);
	var iTaxPayDelta = findYearlyChanges(iTaxPay);
	var invDelta = findYearlyChanges(inv);

	//no data from 155-161
	var prepaidExpDelta = findYearlyChanges(prepaidExp);
	var otherCurrAssetsDelta = findYearlyChanges(otherCurrAssets);
	var aPDelta = findYearlyChanges(aP);
	var otherCurrLiabDelta = findYearlyChanges(otherCurrLiab);
	var accExpDelta = findYearlyChanges(accExp);
	//////////////////////////////////////////////////////////////////////////////////////////

	for (var i = 0; i < years; i++) {
		ebit[i] = grossProfit[i] - (rND[i]*(1+d)) - sNM[i] - otherExp[i];
		interestFX[i] = ebit[i] * (-1*interestRate[i]);
		ebt[i] = ebit[i] - interestFX[i];
		netIncome[i] = ebt[i] - taxes[i];
		earningsPerShare[i] = netIncome[i] / sharesOut[i];
		ebitda[i] = netIncome[i] + interestFX[i] + taxes[i] + dNA[i];
		cashFromOperatingActivities[i] = ebit[i] + iTaxPay[i] + dNA[i] + acctsRecDelta[i] + iTaxPayDelta[i] + prepaidExpDelta[i] + otherCurrAssetsDelta[i] + aPDelta[i] + otherCurrLiabDelta[i] + accExpDelta[i];
	}



	var currentAssets = sumColumnsOfArrays([cashEq,acctsRec,stInv,mktSec,inv,defTaxAssets,prepaidExp,otherCurrAssets]);
	var longTermAssets = sumColumnsOfArrays([tangibleAssets,bldsStructures,machineryEq,furnitureEq,land,accDep,intangAssets,software,goodwill,otherNetInt,invAndOtherAssets,invSec,otherRec,longTimeDeposit,otherLTAssets,allowance]);
	var totAssets = sumColumnsOfArrays ([currentAssets,longTermAssets]);
	var totalCashInvActivities = [];
	var totalCashFinActivities = [];

	for (var i=0; i<totAssets.length; i++) {
		totAssets[i] = totAssets[i] * (1 + b);
		totalCashInvActivities[i] = [disposalFixedAssets[i] + increaseInvestments[i] + decreaseInvestments[i] + purchaseInvSecurities[i] + otherInvestingActivities[i]];
		totalCashFinActivities[i] = [shortTermBorrowingDelta[i]+ increaseLongTermBorrowings[i]+ netIncreaseShortTermLoansPayable[i] + DecreaseLongTermBorrowings[i]+ IncreaseCapitalStocks[i] + DecreaseCapitalStocks[i] + otherFinancingActivities[i] + cashFinancingActivities[i] + NetChangesCash[i]];
	}
	var currentLiabilities = sumColumnsOfArrays([stNP,stDebt,stBorrowing,currentInstLTDebt,bondsDue,aP,accExp,iTaxPay,allowProd,divPay,otherCurrLiab]);
	var nonCurrentLiab = sumColumnsOfArrays([ltDebt,bond,bondWarrant,ltBorrow,defTaxLiab,provRiskCharge,retirementSevBenef,otherNonCurrLiab]);
	var totLiab = sumColumnsOfArrays([currentLiabilities, nonCurrentLiab]);
	var stockhldrsEq = sumColumnsOfArrays([redeemablePrefStock,addPic,retainedEarnings,tStock,commonEq,assetLiabDiffPlug,cumTranslAdj,unrealizedGainLossMktSec]);
	

	// assets will not be connected to price target. only several current assets lie within findDifferences, which lies in cashFromOperatingActivities. so totalAssets do not affect the price target directly. we can take out total asset growth as a user input if you want.
	//revenue should flow into ebt, then opCF's, then FCF, and the P.T. Not sure why it isn't working
	// var cashEq[] = cash ( from prior year) + netChangeCash

	var capEx = []
	capEx = fillArray(capEx, 1, years)
	for (var i=0; i<capEx.length; i++) {
		capEx[i] = capEx[i] * (1+c);
	}
	
	var freeCashFlow = findDifferences(cashFromOperatingActivities,capEx);

	var wacc = .115;
	var terminalGrowthRate = .003;
	var netChangeCash = [];
	var termVal = [];
	var dcf = [];

	for (var i = 0; i < years; i++) {
		netChangeCash[i] = cashFromOperatingActivities[i] + totalCashInvActivities[i] + totalCashFinActivities[i];
		termVal[i] = (freeCashFlow[i] * (1 + terminalGrowthRate)) / (wacc - terminalGrowthRate);
		dcf[i] = freeCashFlow[i]/Math.pow(1+wacc,i);
	}
	
	var totalSumOfDiscountedCashFlows = findSumOfArray(dcf);

	//get cashEq and totalDebt
	var ev = [];
	var priceTarget = [];

	for (var i = 0; i < dcf.length; i++) {
		ev[i] = dcf[i] + termVal[i];
		priceTarget[i] = ev[i] / sharesOut[i];
	}
	return priceTarget;
}
//alternate price charts derived from ratios
//PE ratio is set beforehand
function getPERatio() {
	var pEPrices = [];
	var pERatios = [1,2,3,4,5];
	for (var i=0; i<pERatios.length; i++) {
		pEPrices[i] = pERatios[i] * earningsPerShare[i];
	}
	return pEPrices;
}

//PB ratio is set beforehand
function getPBRatio() {
	var pBPrices = [];
	var pBRatios = [1,1,1,1,1];
	for (var i=0; i<pBRatios.length; i++) {
		pBPrices[i] = pBRatios[i] * bookValue[i];
	}
	return pBPrices;
}
//PS ratio is set beforehand
function getPSRatio() {
	var pSPrices = [];
	var pSRatios = [1,1,1,1,1];
	for (var i=0; i<pSRatios.length; i++) {
		pSPrices[i] = pSRatios[i] * revenues[i];
	}
	return pSPrices;
}
//PFCF ratio is set beforehand
function getPCFRatio() {
	var pFCFPrices = [];
	var pFCFRatios = [1,1,1,1,1];
	for (var i=0; i<pFCFRatios.length; i++) {
		pFCFPrices[i] = pFCFRatios[i] * freeCashFlow[i];
	}
	return pFCFPrices;
}

//PE ratio is derived from regular price outputs

function getPERatio1() {
	var priceTarget = [];
	var pERatios1 = [];
	for (var i=0;i<pERatios1.length;i++) {
		pERatios1[i] = priceTarget[i]/earningsPerShare[i];
	}
	return pERatios1;
}
//PB ratio is derived from regular price outputs
function getPBRatio1() {
	var priceTarget = [];
	var pBRatios1 = [];
	for (var i=0;i<pBRatios1.length;i++) {
		pBRatios1[i] = priceTarget[i]/bookValue[i];
	}
	return pBRatios1;
}
//PS ratio is derived from regular price outputs
function getPSRatio1() {
	var priceTarget = [];
	var pSRatios1 = [];
	for (var i=0;i<pSRatios1.length;i++) {
		pSRatios1[i] = priceTarget[i]/revenues[i];
	}
	return pSRatios1;
}
//PFCF ratio is derived from regular price outputs
function getPFCFRatio1() {
	var priceTarget = [];
	var pFCFRatios1 = [];
	for (var i=0;i<pFCFRatios1.length;i++) {
		pFCFRatios1[i] = priceTarget[i]/freeCashFlow[i];
	}
	return pFCFRatios1;
}







//////////////////////////// NON FINANCIAL HELPER FUNCTIONS ///////////////////////					
function divideArrays(a, b) {
	var quotient = 0;
	for (var i =0; i<a.length; i++) {
		quotient[i] = a[i] / b[i];
	}
	return quotient;
}

function multiplyArrays(a,b) {
	var product = []
	for (var i=0; i<a.length; i++) {
		product[i] = a[i] * b[i];
	}
	return product;
}

function sumValues(a,b,c,d) {
	var total = a + b + c + d;
	return total;
}

function sumColumnsOfArrays(array) {
		var total = [];
		for (var i=0; i < array[0].length; i++) {
			total[i] = 0;
		}
		for (var i=0; i < array.length; i++) {
			for (var j=0; j < array[0].length; j++) {
				total[j] += array[i][j];
			}
		}
		return total;
	}

function findYearlyChanges(array) {
	var changes = [];
	changes[0] = 0;
	for (var i=1; i<array.length; i++) {
		changes[i] = array[i-1] - array[i];
	}
	return changes;
}

function fillArray(array, value, positions) {
	//blank array
	array = [];
	for (var i = 0; i < positions; i++) {
		array[i] = value;
	}
	return array;
}

function findDifferences(arrayOne, arrayTwo) {
	var diffs = [];
	for (var i = 0; i < arrayOne.length; i++) {
		diffs[i] = arrayOne[i] - arrayTwo[i];
	}
	return diffs;
}

function findSumOfArray(array) {
	var total = 0;
	for (var i = 0; i < array.length; i++) {
		total += array[i];
	}
	return total;
}

function adjustData(data,float) {
	for (var i=0; i<data.length; i++) {
		data[i] = data[i] * (1+float);
	}
}
/////////////////////////END NON FINANCIAL HELPER FUNCTIONS ///////////////////////